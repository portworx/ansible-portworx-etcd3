# tasks for portworx-etcd3 role
- name: Remove any old existing etcd
  package:
    name: etcd
    state: absent
  ignore_errors: yes
- name: Remove any old existing etcd2
  package:
    name: etcd2
    state: absent
  ignore_errors: yes
- name: Remove any old existing etcd3
  package:
    name: etcd3
    state: absent
  ignore_errors: yes
- name: install the latest version of wget
  package:
    name: wget
    state: latest
- name: Set up persistent etcd data directory
  file: 
    path:  /var/lib/etcd 
    state: directory
    owner: root
    group: root
    mode:  0775
- name:  Make tempdir
  file:
     path: /tmp/etcd
     state: directory
     owner: root
     group: root
     mode:  0775
- name:  Fetch new etcd
  get_url: 
     url: https://github.com/coreos/etcd/releases/download/v{{ etcd_version }}/etcd-v{{ etcd_version }}-linux-amd64.tar.gz 
     dest: /tmp/
- name: Unarchive new etcd
  unarchive: 
       src: /tmp/etcd-v{{ etcd_version }}-linux-amd64.tar.gz 
       dest: /tmp
       remote_src: yes
- name: Install new etcd
  shell: |
       cd /tmp/etcd-v{{ etcd_version }}-linux-amd64
       mv etcd etcdctl /usr/local/bin
       chmod 755 /usr/local/bin/etcd /usr/local/bin/etcdctl
- template:
     src: ../templates/etcd3.service.js
     dest: /etc/systemd/system/etcd3.service
     owner: root
     group: root
     mode: 0644
- name: Reload and start the services
  shell: |
     systemctl daemon-reload
     systemctl enable etcd3.service
     systemctl start  etcd3.service
